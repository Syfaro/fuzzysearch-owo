{% extends "base.html" %}

{% block content %}
<section class="section" data-account-id="{{ account.id }}">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-one-third">
        <h1 class="title has-text-centered">FuzzySearch OwO</h1>

        <h2 class="subtitle has-text-centered">
          {{ account.source_site.to_string() }} &mdash;
          <strong>{{ account.username }}</strong>
        </h2>
      </div>
    </div>

    <div class="columns is-centered">
      <div class="column">
        <nav class="level">
          <div class="level-item has-text-centered">
            <div>
              <p class="heading">Status</p>
              <p class="title" id="account-loading-state">{{ account.loading_state() }}</p>

              {% if account.is_loading() %}
              <progress id="account-import-progress" class="progress is-small is-primary mt-2"
                max="100">Unknown</progress>
              {% endif %}
            </div>
          </div>

          <div class="level-item has-text-centered">
            <div>
              <p class="heading">Items</p>
              <p class="title">{{ item_count }}</p>
            </div>
          </div>

          <div class="level-item has-text-centered">
            <div>
              <p class="heading">Content Size</p>
              <p class="title">{{ total_content_size|filesizeformat }}</p>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <div class="columns is-centered">
      <div class="column is-one-third">
        {% match account.verification_key() %}
        {% when Some with (verification_key) %}
        <div class="block">
          <article class="message is-warning">
            <div class="message-header">
              <p>Verify Account</p>
            </div>

            <div class="message-body">
              <p class="block">
                You must verify your account before posts can be imported. Please add the following code somewhere on
                your public profile. As soon as your account has been verified you may remove it.
              </p>

              <p class="block">
                <code id="verification-key">{{ verification_key }}</code>
              </p>

              <div class="block">
                <div class="control">
                  <button class="button is-fullwidth is-primary" id="verify-account">Verify Account</button>
                </div>
              </div>
            </div>
            </message>
        </div>
        {% else %}
        {% endmatch %}

        <div class="block">
          <form method="POST" action="/user/account/remove">
            <input type="hidden" name="account_id" value="{{ account.id }}">
            <div class="field is-grouped">
              <div class="control is-flex-grow-1">
                <a href="/user/home" class="button is-outlined is-info is-fullwidth">Home</a>
              </div>
              <div class="control is-flex-grow-1">
                <button class="button is-danger is-fullwidth">Remove Account</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const verificationKey = document.getElementById('verification-key');
  if (verificationKey) {
    verificationKey.style.cursor = 'pointer';

    verificationKey.addEventListener('click', (ev) => {
      navigator.clipboard.writeText(verificationKey.textContent).then(() => {
        bulmaToast.toast({
          message: 'Code copied to clipboard',
          type: 'is-info',
        });
      });
    });
  }

  const verifyAccountButton = document.getElementById('verify-account');
  if (verifyAccountButton) {
    const accountID = document.querySelector('section[data-account-id]').dataset.accountId;

    verifyAccountButton.addEventListener('click', (ev) => {
      verifyAccountButton.classList.add('is-loading');

      fetch('/user/account/verify', {
        method: 'post',
        body: new URLSearchParams({
          'account_id': accountID,
        }),
        credentials: 'same-origin',
        headers: {
          'content-type': 'application/x-www-form-urlencoded',
        },
      })
      .then((resp) => console.debug(resp));
    });
  }
</script>
{% endblock %}
