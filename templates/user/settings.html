{% import "_pagination.html" as pagination %}

{% macro site_option(site, selected) %}
  {% let is_selected = selected.contains(site) %}
  <option value="{{ site }}" {% if is_selected %}selected{% endif %}>
    {{ site }}
  </option>
{% endmacro %}

{% block header %}
  <style>
    code {
      white-space: nowrap;
    }
  </style>
{% endblock %}

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-one-third">
        <h1 class="title has-text-centered">Settings</h1>

        {% match saved_message %}
        {% when Some with ((successful, saved_message)) %}
        <div class="notification {% if successful %} is-success {% else %} is-danger {% endif %}">
          <p>{{ saved_message }}</p>
        </div>
        {% else %}
        {% endmatch %}

        <form method="POST">
          <div class="block">
            <h2 class="subtitle is-4">Profile</h2>

            <div class="field">
              <label class="label" for="profile-name">Name</label>
              <div class="control">
                <input class="input" type="text" placeholder="Name" name="display-name"
                  value="{{ user.display_name() }}" id="profile-name" required>
              </div>
            </div>

            <div class="field">
              <label class="label" for="profile-email">Email address</label>
              <div class="control">
                <input class="input" type="email" placeholder="Email" name="email"
                  value="{{ user.email.as_deref().unwrap_or_default() }}" id="profile-email" autocomplete="email">
              </div>

              {% if user.has_unverified_email() %}
              <p class="help">A link was sent to your email address, please follow it to verify your account.</p>
              {% endif %}
            </div>
          </div>

          <div class="block">
            <h2 class="subtitle is-4">Notifications</h2>

            <div class="field">
              <label class="label" for="email-frequency">Email frequency</label>

              <div class="control is-expanded">
                <div class="select is-fullwidth">
                  <select name="email-frequency" id="email-frequency" {% if user.email_verifier.is_some() %} disabled {% endif %}>
                    {% call pagination::option("Never", "never", email_frequency) %}
                    {% call pagination::option("Instantly", "instantly", email_frequency) %}
                    {% call pagination::option("Daily", "daily", email_frequency) %}
                    {% call pagination::option("Weekly", "weekly", email_frequency) %}
                  </select>
                </div>
              </div>

              {% if user.email_verifier.is_some() %}
              <p class="help">You must verify your email address before receiving notifications.</p>
              {% else %}
              <p class="help">
                Select how frequently you want to receive emails.
                The daily and weekly options aggregate notifications into a single email for that time period.
              </p>
              {% endif %}
            </div>

            <div class="field">
              <h3 class="subtitle is-5">Telegram notifications</h3>

              <label class="checkbox" for="telegram-notifications">
                <input type="checkbox" id="telegram-notifications" name="telegram-notifications" {% if user.telegram_id.is_none() %} disabled {%
                  else if telegram_notifications.0 %} checked {% endif %}>
                Send Telegram messages
              </label>

              {% if user.telegram_id.is_none() %}
              <p class="help">You must add your Telegram account first.</p>

              <div class="block has-text-centered">
                <script async src="https://telegram.org/js/telegram-widget.js?15"
                  data-telegram-login="{{ telegram_login.bot_username }}" data-size="large"
                  data-auth-url="{{ telegram_login.auth_url }}" data-request-access="write"></script>
              </div>
              {% else %}
              <p class="help">Telegram messages are sent as soon as matches are found.</p>
              {% endif %}
            </div>
          </div>

          <div class="block">
            <h2 class="subtitle is-4">Sites</h2>

            <div class="field">
              <label class="label" for="skipped-sites">Skipped sites</label>
              <div class="select is-multiple is-fullwidth">
                {% let sites = Site::visible_sites() %}
                <select name="skipped-sites" id="skipped-sites" multiple size="{{ sites.len() }}">
                  {% for site in sites %}
                    {% call site_option(site, skipped_sites.0) %}
                  {% endfor %}
                </select>
              </div>

              <p class="help">
                Any images posted to sites selected here will <strong>not</strong> generate notifications.
              </p>
            </div>
          </div>

          <div class="field">
            <div class="control">
              <button class="button is-primary is-fullwidth">Save Settings</button>
            </div>
          </div>

          <div class="block mt-6">
            <h2 class="subtitle is-4">Security</h2>

            <a class="button is-link is-outlined" href="/auth/sessions">Active Sessions</a>
          </div>

          <div class="block mt-6">
            <h2 class="subtitle is-4">Integrations</h2>

            <div class="field">
              <h3 class="subtitle is-5">RSS feed</h3>

              <a type="application/rss+xml" class="button"
                href="/user/feed/rss?u={{ user.id.as_url() }}&t={{ user.rss_token.as_url() }}">Subscribe to RSS feed</a>
            </div>

            <div class="field mt-5">
              <h3 class="subtitle is-5">API Access</h3>

              <label class="label" for="api-username">Username</label>
              <div class="control">
                <input type="text" class="input" value="{{ user.id.as_url() }}" id="api-username" readonly>
              </div>

              <label class="label" for="api-password">Password</label>
              <div class="control">
                <input type="text" class="input" value="{{ user.api_token.as_url() }}" id="api-password" readonly>
              </div>

              <p class="help">
                You may use this username and password for basic auth to upload
                new images by sending a POST request to <code>/api/upload</code>.
                Use a multipart form, putting images in a field named
                <code>image</code>. You may specify the header
                <code>x-image-title</code> on the multipart field to set the title
                for that image.
              </p>
            </div>
          </div>

          <div class="field mt-6">
            <div class="control">
              <button id="delete-account" class="button is-danger is-outlined"
                formaction="/user/delete">Delete Account</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

{% block footer %}
<script>
  document.getElementById('delete-account').addEventListener('click', (ev) => {
    const wasIntentional = confirm('Are you sure you want to delete your account?');
    if (!wasIntentional) {
      ev.preventDefault();
    }
  });
</script>
{% endblock %}
